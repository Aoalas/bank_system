<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 | 银行储蓄系统</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<canvas id="universe"></canvas>

<div class="page-center">
    <div class="geek-card" style="width: 100%; max-width: 420px; padding: 40px;">
        <div class="page-title">
            <i class="fas fa-cube"></i>
            <h2>银行储蓄系统</h2>
            <p style="font-size: 14px; color: var(--second-text); margin-top: 5px;">项目总负责人：刘焯林</p>
        </div>

        <form id="loginForm">
            <div class="input-group">
                <input type="text" id="cardNumber" placeholder=" " required autocomplete="off">
                <label>储蓄卡号</label>
            </div>

            <div class="input-group">
                <input type="password" id="password" placeholder=" " required>
                <label>访问密码</label>
            </div>

            <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
                登录系统 <i class="fas fa-arrow-right"></i>
            </button>

            <div style="text-align: right; margin-top: 10px;">
                <a href="javascript:showResetModal()" style="color: var(--anzhiyu-secondtext); font-size: 12px;">忘记密码?</a>
            </div>
        </form>

        <div style="text-align: center; margin-top: 25px;">
            <span style="color: var(--second-text);">还没有账户？</span>
            <a href="/register.html" style="color: var(--theme-color); font-weight: bold; text-decoration: none;">立即开户</a>
        </div>

        <div style="margin-top: 30px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px dashed var(--border-color);">
            <div style="font-size: 12px; color: var(--second-text); margin-bottom: 8px;">
                <i class="fas fa-terminal"></i> DEBUG_ACCOUNTS:
            </div>
            <div style="font-family: monospace; font-size: 12px; color: #818cf8;">
                > User1: 6222020111111111001 / 123456<br>
                > User2: 6222020222222222002 / 123456<br>
                > User3: 6222020333333333003 / 123456
            </div>
        </div>
    </div>
</div>

<div id="resetModal" class="modal-wrap">
    <div class="modal-inner">
        <h3 style="text-align: center; margin-bottom: 20px;">重置密码</h3>
        <p style="font-size: 12px; color: var(--anzhiyu-secondtext); margin-bottom: 15px; text-align: center;">请验证身份以设置新密码</p>

        <div class="input-group"><input type="text" id="rstCard" placeholder=" "><label>储蓄卡号</label></div>
        <div class="input-group"><input type="text" id="rstName" placeholder=" "><label>真实姓名</label></div>
        <div class="input-group"><input type="text" id="rstPhone" placeholder=" "><label>预留手机号</label></div>

        <div style="height: 1px; background: var(--style-border); margin: 15px 0;"></div>

        <div class="input-group"><input type="password" id="rstNewPwd" placeholder=" "><label>设置新密码</label></div>
        <div class="input-group"><input type="password" id="rstConfirmPwd" placeholder=" "><label>确认新密码</label></div>

        <div style="display: flex; gap: 10px;">
            <button class="btn btn-outline" onclick="closeResetModal()">取消</button>
            <button class="btn btn-primary" onclick="submitReset()">重置密码</button>
        </div>
    </div>
</div>

<div id="message" class="snackbar"></div>

<script>
    const canvas = document.getElementById('universe');
    const ctx = canvas.getContext('2d');
    let width, height, stars = [];

    function init() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        stars = [];
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * width,
                y: Math.random() * height,
                size: Math.random() * 2,
                speed: Math.random() * 0.5
            });
        }
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
        stars.forEach(star => {
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
            ctx.fill();
            star.y -= star.speed;
            if (star.y < 0) star.y = height;
        });
        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', init);
    init();
    animate();

    // 登录逻辑
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = this.querySelector('button[type="submit"]');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> 验证中...';
        btn.style.opacity = '0.7';

        const cardNumber = document.getElementById('cardNumber').value;
        const password = document.getElementById('password').value;

        try {
            const res = await fetch('/api/login', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ card_number: cardNumber, password: password })
            });
            const result = await res.json();

            if (result.status === 'success') {
                showToast('验证通过，正在进入...', 'success');
                sessionStorage.setItem('cardNumber', cardNumber);
                setTimeout(() => window.location.href = '/dashboard.html', 800);
            } else {
                showToast(result.message || '登录失败', 'error');
                btn.innerHTML = originalHTML; btn.style.opacity = '1';
            }
        } catch (error) {
            showToast('服务器连接失败', 'error');
            btn.innerHTML = originalHTML; btn.style.opacity = '1';
        }
    });

    // === 重置密码逻辑 ===
    function showResetModal() { document.getElementById('resetModal').style.display = 'flex'; }
    function closeResetModal() { document.getElementById('resetModal').style.display = 'none'; }

    async function submitReset() {
        const card = document.getElementById('rstCard').value;
        const name = document.getElementById('rstName').value;
        const phone = document.getElementById('rstPhone').value;
        const newPwd = document.getElementById('rstNewPwd').value;
        const cfmPwd = document.getElementById('rstConfirmPwd').value;

        if(!card || !name || !phone || !newPwd) return showToast('请填写完整信息', 'error');
        if(newPwd !== cfmPwd) return showToast('两次密码不一致', 'error');

        try {
            const res = await fetch('/api/password/reset', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({card_number: card, name: name, phone: phone, new_password: newPwd})
            });
            const ret = await res.json();
            if(ret.status === 'success') {
                showToast('密码重置成功，请重新登录', 'success');
                closeResetModal();
            } else {
                showToast(ret.message || '验证失败，信息不匹配', 'error');
            }
        } catch(e) { showToast('网络错误', 'error'); }
    }

    let snackbarTimer = null;
    function showToast(msg, type) {
        const oldEl = document.getElementById('message');
        if(!oldEl) return;
        if (snackbarTimer) { clearTimeout(snackbarTimer); snackbarTimer = null; }
        const newEl = oldEl.cloneNode(false);
        oldEl.parentNode.replaceChild(newEl, oldEl);
        newEl.textContent = msg;
        newEl.className = `snackbar ${type}`;
        newEl.style.display = 'block';
        snackbarTimer = setTimeout(() => {
            newEl.classList.add('hide');
            newEl.addEventListener('animationend', () => { if(newEl.classList.contains('hide')) newEl.style.display = 'none'; }, {once:true});
        }, 3000);
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal-wrap')) {
            event.target.style.display = 'none';
        }
    }
</script>
</body>
</html>